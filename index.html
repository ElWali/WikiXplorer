<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WikiXplorer</title>
    
    <!-- Mapbox GL JS -->
    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
    
    <!-- Mapbox Geocoder -->
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css">
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }
        
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        
        /* Welcome Screen */
        .WelcomeDiv {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            color: white;
            text-align: center;
            transition: opacity 0.5s;
        }
        
        .WelcomeDiv h1 {
            font-size: 3em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
        }
        
        .WelcomeDiv p {
            font-size: 1.2em;
            max-width: 600px;
            margin: 20px auto;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
        }
        
        .startButton {
            background-color: rgba(75, 121, 130, 0.8);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2em;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
            transition: background-color 0.3s;
        }
        
        .startButton:hover {
            background-color: rgba(75, 121, 130, 1);
        }
        
        #coverContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 90;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        #geocoderWelcome {
            width: 50%;
            max-width: 600px;
            margin-bottom: 20px;
        }
        
        /* Panel */
        #panel {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 350px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            padding: 20px;
            z-index: 10;
            display: none;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        #panel h2 {
            margin-top: 0;
            color: #4B7982;
        }
        
        #article-title {
            margin: 0 0 10px 0;
            font-size: 1.5em;
        }
        
        #article-year {
            color: #666;
            font-style: italic;
            margin-bottom: 15px;
        }
        
        #article-intro {
            line-height: 1.5;
            margin-bottom: 15px;
        }
        
        #articleimage {
            width: 100%;
            margin-bottom: 15px;
            display: none;
        }
        
        #article-image {
            width: 100%;
            border-radius: 5px;
        }
        
        .listitem {
            margin-bottom: 10px;
            display: none;
        }
        
        .listitem a {
            color: #4B7982;
            text-decoration: none;
        }
        
        .listitem a:hover {
            text-decoration: underline;
        }
        
        /* Context Menu */
        #context-menu {
            position: absolute;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            display: none;
            z-index: 1000;
            min-width: 180px;
        }
        
        #context-menu ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }
        
        #context-menu li {
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
        }
        
        #context-menu li:last-child {
            border-bottom: none;
        }
        
        #context-menu a {
            color: #333;
            text-decoration: none;
            display: block;
        }
        
        #context-menu a:hover {
            color: #4B7982;
        }
        
        /* Random Location Button (map-side) */
        #randomButtonMap {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background-color: #4B7982;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 10;
        }
        
        #randomButtonMap:hover {
            background-color: #3a6068;
        }
        
        /* Geocoder on map */
        #geocoderMap {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 10;
            width: 300px;
        }
        
        /* Loading indicator */
        #loadingBox {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.8);
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 10;
            display: none;
        }

        /* Mobile tweaks */
        @media (max-width: 600px) {
            #panel {
                right: 0;
                left: 0;
                bottom: 0;
                top: auto;
                width: 100%;
                max-height: 50vh;
            }
            #geocoderMap {
                width: 80%;
            }
        }
    </style>
</head>
<body>
    <!-- Welcome Screen -->
    <div class="WelcomeDiv">
        <h1>WikiXplorer</h1>
        <p>Discover Wikipedia articles on a map! Click locations to learn about places around the world.</p>
        <div id="geocoderWelcome"></div>
        <button class="startButton">Get Started</button>
        <p>Or <button id="randomButtonWelcome" class="startButton">Go to Random Location</button></p>
    </div>
    
    <div id="coverContainer"></div>
    
    <!-- Main Map -->
    <div id="map"></div>
    
    <!-- Info Panel -->
    <div id="panel">
        <h2 id="article-title">Article Title</h2>
        <div id="article-year"></div>
        <div id="article-intro"></div>
        <div id="articleimage">
            <img id="article-image" src="img/loading.gif" alt="Loading image...">
        </div>
        
        <div class="listitem">
            <a id="article-wikidata" href="#" target="_blank">View on Wikidata</a>
        </div>
        <div class="listitem">
            <a id="article-wikipedia" href="#" target="_blank">View full Wikipedia article</a>
        </div>
        <div class="listitem">
            <a id="article-wikicommons" href="#" target="_blank">View on Wikimedia Commons</a>
        </div>
        <div class="listitem">
            <a id="article-google-search" href="#" target="_blank">Search on Google</a>
        </div>
        <div class="listitem">
            <a id="article-google-maps" href="#" target="_blank">View on Google Maps</a>
        </div>
        <div class="listitem">
            <a id="article-official-website" href="#" target="_blank">Official Website</a>
        </div>
    </div>
    
    <!-- Loading Indicator -->
    <div id="loadingBox">Loading articles...</div>
    
    <!-- Context Menu -->
    <div id="context-menu">
        <ul>
            <li><a id="google-maps-link" href="#" target="_blank">Google Maps</a></li>
            <li><a id="apple-maps-link" href="#" target="_blank">Apple Maps</a></li>
            <li><a id="bing-maps-link" href="#" target="_blank">Bing Maps</a></li>
            <li><a id="here-wego-link" href="#" target="_blank">HERE WeGo</a></li>
            <li><a id="openstreetmap-link" href="#" target="_blank">OpenStreetMap</a></li>
            <li><a id="wikishootme-link" href="#" target="_blank">WikiShootMe</a></li>
            <li><a id="mapillary-link" href="#" target="_blank">Mapillary</a></li>
        </ul>
    </div>
    
    <!-- Random Location Button (map view) -->
    <button id="randomButtonMap">Go to Random Location</button>
    
    <!-- Geocoder on map -->
    <div id="geocoderMap"></div>
    
    <script>
        /* ======= MAP SETUP ======= */
        let articlesGeojson = { type: 'FeatureCollection', features: [] };
        let infoPanel = {};
        
        function randCity() {
            const cities = [
                { n: "Paris", c: [2.3522, 48.8566], q: "Q90" },
                { n: "New York", c: [-74.0060, 40.7128], q: "Q60" },
                { n: "Tokyo", c: [139.6917, 35.6895], q: "Q1490" },
                { n: "London", c: [-0.1278, 51.5074], q: "Q84" },
                { n: "Rome", c: [12.4964, 41.9028], q: "Q220" },
                { n: "Sydney", c: [151.2093, -33.8650], q: "Q36" }
            ];
            return cities[Math.floor(Math.random() * cities.length)];
        }
        
        const startLocation = randCity();
        mapboxgl.accessToken = 'pk.eyJ1IjoiY2Fza2VzIiwiYSI6ImNsZGtwdGRrdzA4dWMzb3BoMWdxM3Zib2UifQ.2q2xfShG5nmDHTxg7n_ZhQ';
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/caskes/cldkq0ha9000r01n3hjgwtkrn',
            center: startLocation.c,
            zoom: 15,
            hash: true
        });
        map.addControl(new mapboxgl.NavigationControl(), 'bottom-right');
        
        /* ====== RANDOM LOCATION ====== */
        function newRandomLocation() {
            const location = randCity();
            map.flyTo({ center: location.c, zoom: 15 });
        }
        document.getElementById('randomButtonWelcome').addEventListener('click', newRandomLocation);
        document.getElementById('randomButtonMap').addEventListener('click', newRandomLocation);
        
        /* ===== WELCOME SCREEN ===== */
        document.querySelectorAll('.startButton').forEach(button => {
            button.addEventListener('click', hideWelcomCoverPage);
        });
        function hideWelcomCoverPage() {
            $('.WelcomeDiv').fadeOut();
            $('#coverContainer').fadeOut();
        }
        
        /* Hover Popup */
        let hoverPopup = new mapboxgl.Popup({ closeButton: false, closeOnClick: true });
        let listPopup = new mapboxgl.Popup({ closeButton: true, closeOnClick: true });
        
        /* Geocoder on welcome */
        let geocoder = new MapboxGeocoder({ accessToken: mapboxgl.accessToken, mapboxgl: mapboxgl });
        document.getElementById('geocoderWelcome').appendChild(geocoder.onAdd(map));
        
        /* ===== MAP LOAD ===== */
        map.on('load', function () {
            fetchArticlesInBoundingBox();
            let geocoder2 = new MapboxGeocoder({ accessToken: mapboxgl.accessToken, mapboxgl: mapboxgl });
            document.getElementById('geocoderMap').appendChild(geocoder2.onAdd(map));
            map.addSource('wikipediaSource', { type: 'geojson', data: { type:'FeatureCollection', features: [] }, cluster: true, clusterMaxZoom:14, clusterRadius:16 });
            map.addLayer({ id: 'unclustered-point', type:'circle', source:'wikipediaSource', paint:{ 'circle-color':'#4B7982', 'circle-opacity':0.8, 'circle-radius':10, 'circle-stroke-width':1, 'circle-stroke-color':'#fff' }});
            map.addLayer({ id:'cluster-count', type:'symbol', source:'wikipediaSource', filter:['has','point_count'], layout:{ 'text-field':'{point_count_abbreviated}', 'text-font':['DIN Offc Pro Medium','Arial Unicode MS Bold'], 'text-size':12 }, paint:{ 'text-color':'#ffffff' }});

            map.on('mousemove','unclustered-point',hoverPopupOn);
            map.on('mouseleave','unclustered-point',hoverPopupOff);
            map.on('click','unclustered-point',popupOpen);
            map.on('click','cluster-count',popupOpen);

            /* Context menu */
            map.on('contextmenu',function(e){ e.preventDefault(); const point=map.project(e.lngLat); showContextMenu(point);});
            map.on('move',hideContextMenu); map.on('zoom',hideContextMenu); map.on('rotate',hideContextMenu); map.on('dragstart',hideContextMenu); map.on('touchstart',hideContextMenu);
        });
        
        /* === Debounced fetch articles === */
        let fetchTimeout;
        map.on('moveend', function () {
            clearTimeout(fetchTimeout);
            fetchTimeout = setTimeout(fetchArticlesInBoundingBox, 500);
        });

        /* Hover Popup Handling */
        function hoverPopupOn(e){
            hoverPopup.remove();
            let html='';
            if(e.features.length==1){
                html=`<ul><li>${e.features[0].properties.title || 'Multiple articles'}</li></ul>`;
            }else{
                html=`<ul><li>${e.features.length} articles</li></ul>`;
            }
            let coords=e.features[0].geometry.coordinates.slice();
            hoverPopup.setLngLat(coords).setHTML(html).addTo(map);
            $('.mapboxgl-popup-content').css({'background':'transparent','padding':'0'});
            map.getCanvas().style.cursor='pointer';
        }
        function hoverPopupOff(){ map.getCanvas().style.cursor=''; hoverPopup.remove(); }

        /* Context menu */
        function generateContextMenuLinks(lat,lng){
            document.getElementById('google-maps-link').href=`https://www.google.com/maps/?ll=${lat},${lng}&z=${map.getZoom()}&t=k`;
            document.getElementById('apple-maps-link').href=`http://maps.apple.com/?ll=${lat},${lng}&z=${map.getZoom()}&t=s`;
            document.getElementById('bing-maps-link').href=`https://www.bing.com/maps/?v=2&cp=${lat}~${lng}&lvl=${map.getZoom()}&sty=a`;
            document.getElementById('wikishootme-link').href=`https://tools.wmflabs.org/wikishootme/#lat=${lat}&lon=${lng}&zoom=${map.getZoom()}`;
            document.getElementById('openstreetmap-link').href=`https://www.openstreetmap.org/#map=${map.getZoom()}/${lat}/${lng}`;
            document.getElementById('here-wego-link').href=`https://wego.here.com/?map=${lat},${lng},${map.getZoom()},satellite`;
            document.getElementById('mapillary-link').href=`https://www.mapillary.com/app?lat=${lat}&lng=${lng}&z=${map.getZoom()}`;
        }
        function showContextMenu(point){
            const contextMenu=document.getElementById('context-menu');
            const latLng=map.unproject([point.x,point.y]);
            generateContextMenuLinks(latLng.lat,latLng.lng);
            contextMenu.style.left=point.x+'px'; contextMenu.style.top=point.y+'px'; contextMenu.style.display='block';
            map.once('mousedown',hideContextMenu);
        }
        function hideContextMenu(){ document.getElementById('context-menu').style.display='none'; }

        /* Fetch Wikipedia Articles by BBox */
        function fetchArticlesInBoundingBox(){
            const bounds=map.getBounds();
            const boundsArray=[ bounds._ne.lat, bounds._sw.lng, bounds._sw.lat, bounds._ne.lng ];
            const requestURL=`https://en.wikipedia.org/w/api.php?action=query&format=json&list=geosearch&origin=*&utf8=1&gsbbox=${boundsArray.join('|')}&gslimit=500&gsprimary=all`;
            $('#loadingBox').show();
            fetch(requestURL).then(r=>r.json()).then(data=>processArticles(data)).catch(console.error);
        }
        function processArticles(jsonData){
            jsonData.query.geosearch.forEach(value=>{
                if(value.title.startsWith('List of'))return;
                const article={ pageId:value.pageid,title:value.title,lonLat:[value.lon,value.lat], url:`https://en.wikipedia.org/?curid=${value.pageid}` };
                addArticlesToGeojson(article);
            });
            map.getSource('wikipediaSource').setData(articlesGeojson);
            $('#loadingBox').hide();
        }
        function addArticlesToGeojson(article){
            if(articlesGeojson.features.some(f=>f.properties.pageId===article.pageId))return;
            articlesGeojson.features.push({type:'Feature',properties:article,geometry:{type:'Point',coordinates:article.lonLat}});
        }

        /* Placeholder InfoPanel Display */
        function popupOpen(e){ hoverPopup.remove(); console.log(e.features[0].properties); }

        /* Welcome Backgrounds */
        function updateWelcomeDivBackground(){
            const urls=["https://upload.wikimedia.org/wikipedia/commons/thumb/d/dd/Vintage_car_meets_world_heritage_site.jpg/2560px-Vintage_car_meets_world_heritage_site.jpg","https://upload.wikimedia.org/wikipedia/commons/thumb/f/ff/Ana_rosa_metro_station%2C_S%C3%A3o_Paulo%2C_Brazil.jpg/2560px-Ana_rosa_metro_station%2C_S%C3%A3o_Paulo%2C_Brazil.jpg"];
            document.querySelector('.WelcomeDiv').style.backgroundImage=`url("${urls[Math.floor(Math.random()*urls.length)]}")`;
        }
        updateWelcomeDivBackground();
    </script>
</body>
</html>
